<div class="container mt-4">
  <!-- Filter -->
  <div class="mb-4 position-relative">
    <input
      type="text"
      class="form-control"
      placeholder="Filter by price, location, marble ID, phone, or order name"
      [(ngModel)]="filterText"
      (input)="filterOrders()"
      aria-label="Filter orders"
    />
    <button
      *ngIf="filterText"
      class="btn btn-clear position-absolute end-0 top-0 mt-1 me-2"
      (click)="clearFilter()"
      aria-label="Clear filter"
      title="Clear filter"
    >
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- No orders -->
  <div *ngIf="!isLoading && filteredCommandes.length === 0" class="alert alert-info">
    No orders found.
  </div>

  <!-- Orders Table -->
  <div class="table-responsive" *ngIf="!isLoading && filteredCommandes.length > 0">
    <table class="table table-striped table-hover table-bordered">
      <thead class="table-dark">
        <tr>
          <th (click)="sortBy('order_name')" class="sortable">
            Order Name
            <span *ngIf="sortField === 'order_name'" [ngClass]="sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'"></span>
          </th>
          <th (click)="sortBy('totalPrice')" class="sortable">
            Total Price
            <span *ngIf="sortField === 'totalPrice'" [ngClass]="sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'"></span>
          </th>
          <th (click)="sortBy('location')" class="sortable">
            Location
            <span *ngIf="sortField === 'location'" [ngClass]="sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'"></span>
          </th>
          <th>Marbles</th>
          <th>Phone</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let commande of filteredCommandes">
          <td>{{ commande.order_name || 'N/A' }}</td>
          <td>{{ commande.totalPrice | currency }}</td>
          <td>
            <button
              *ngIf="commande.location?.lat && commande.location?.lng; else noLocation"
              class="btn btn-link p-0"
              (click)="openMap(commande.location.lat, commande.location.lng)"
              aria-label="View order location"
              title="Open in Google Maps"
            >
              <svg width="16" height="16" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.6 3.95 5.32 5.64 3.64C7.32 1.95 9.61 1 12 1C14.39 1 16.68 1.95 18.36 3.64C20.05 5.32 21 7.61 21 10Z" />
                <path d="M12 13C13.66 13 15 11.66 15 10C15 8.34 13.66 7 12 7C10.34 7 9 8.34 9 10C9 11.66 10.34 13 12 13Z" />
              </svg>
            </button>
            <ng-template #noLocation>
              <span class="text-muted">N/A</span>
            </ng-template>
          </td>
          <td>
            <div *ngFor="let item of commande.marbles" class="d-flex align-items-center gap-2">
              <img
                [src]="item.marbleData?.imageurl || 'assets/placeholder.png'"
                alt="Marble image"
                width="50"
                height="50"
                class="img-thumbnail"
              />
              <span>
                {{ getmarabelName(item._id) || 'Unknown' }} (x{{ item.count }})
              </span>
            </div>
          </td>

          <td>{{ commande.number_of_phone || 'N/A' }}</td>
          <td class="d-flex gap-2 flex-wrap">
            <button
              class="btn btn-success btn-sm"
              [disabled]="commande.status === 'validated'"
              (click)="validateCommande(commande)"
            >
              <i class="fas fa-check-circle me-1"></i> Validate
            </button>
            <button
              class="btn btn-danger btn-sm"
              [disabled]="commande.status === 'rejected'"
              (click)="rejectCommande(commande)"
            >
              <i class="fas fa-times-circle me-1"></i> Reject
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Chart Section -->
  <div class="mt-5">
    <canvas baseChart [data]="chartData" [type]="chartType"></canvas>
  </div>
</div>
